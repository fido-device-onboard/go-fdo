name: Update Nix Dependencies

on:
  pull_request:
    paths:
      - "**/go.sum"

# This permission is needed for the action to push to the PR branch.
# For PRs from forks, the token will be read-only and the push will fail.
# In that case, the PR author will need to grant maintainers permission to edit the PR.
permissions:
  contents: write

jobs:
  update-nix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          # Checkout the head of the PR branch.
          ref: ${{ github.head_ref }}
          # We need full history to amend the commit.
          fetch-depth: 0

      - name: Install Nix
        uses: cachix/install-nix-action@456688f15bc354bef6d396e4a35f4f89d40bf2b7
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Update gomod2nix.toml and modules.txt
        run: |
          set -ex
          # Enter the nix shell and run the update commands
          nix develop --command bash -c '
            set -ex
            go work init
            go work use -r .
            go work vendor
            mv vendor/modules.txt nix/
            gomod2nix
            mv gomod2nix.toml nix/
          '

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add nix/gomod2nix.toml nix/modules.txt
          # Amend the commit only if there are changes.
          if ! git diff --staged --quiet; then
            git commit --amend --no-edit
            git push --force
          else
            echo "No changes to commit"
          fi
