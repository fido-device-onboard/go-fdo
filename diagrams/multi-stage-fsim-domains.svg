<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg width="900" height="650" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .title { font-family: Arial, sans-serif; font-size: 22px; font-weight: bold; fill: #333; }
      .subtitle { font-family: Arial, sans-serif; font-size: 14px; fill: #666; }
      .layer-title { font-family: Arial, sans-serif; font-size: 14px; font-weight: bold; fill: #333; }
      .layer-text { font-family: Arial, sans-serif; font-size: 12px; fill: #555; }
      .fsim-title { font-family: Arial, sans-serif; font-size: 13px; font-weight: bold; fill: #fff; }
      .fsim-text { font-family: Arial, sans-serif; font-size: 11px; fill: #fff; }
      .stage-label { font-family: Arial, sans-serif; font-size: 11px; fill: #666; font-style: italic; }
      .note-text { font-family: Arial, sans-serif; font-size: 11px; fill: #555; }
    </style>
  </defs>

  <!-- Title -->
  <text x="450" y="30" class="title" text-anchor="middle">Multi-Stage FDO Onboarding: FSIMs Across Domains</text>
  <text x="450" y="50" class="subtitle" text-anchor="middle">FSIMs span multiple execution stages - credentials persist across all</text>

  <!-- Left side: Stage Labels -->
  <text x="30" y="95" class="stage-label">Stage</text>
  
  <!-- Layer 1: Firmware/BMO -->
  <rect x="120" y="80" width="760" height="80" rx="5" fill="#e8f4fc" stroke="#3498db" stroke-width="2"/>
  <text x="140" y="105" class="layer-title">1. Firmware / BMO</text>
  <text x="140" y="125" class="layer-text">BIOS/UEFI runs FDO to establish network and receive boot image</text>
  <text x="140" y="145" class="layer-text">Examples: Wi-Fi SSID, password, EFI application, bootable ISO</text>

  <!-- Layer 2: OS Installer -->
  <rect x="120" y="170" width="760" height="80" rx="5" fill="#fef5e7" stroke="#e67e22" stroke-width="2"/>
  <text x="140" y="195" class="layer-title">2. OS Installation</text>
  <text x="140" y="215" class="layer-text">Installer runs FDO to get system configuration</text>
  <text x="140" y="235" class="layer-text">Examples: Hostname, timezone, language, kickstart/preseed config</text>

  <!-- Layer 3: First Boot -->
  <rect x="120" y="260" width="760" height="80" rx="5" fill="#eafaf1" stroke="#27ae60" stroke-width="2"/>
  <text x="140" y="285" class="layer-title">3. OS First Boot</text>
  <text x="140" y="305" class="layer-text">Installed OS runs FDO for additional configuration</text>
  <text x="140" y="325" class="layer-text">Examples: SSH keys, admin credentials, TLS certificates</text>

  <!-- Layer 4: Application -->
  <rect x="120" y="350" width="760" height="80" rx="5" fill="#f5eef8" stroke="#9b59b6" stroke-width="2"/>
  <text x="140" y="375" class="layer-title">4. Application Setup</text>
  <text x="140" y="395" class="layer-text">Application runs FDO for service connectivity</text>
  <text x="140" y="415" class="layer-text">Examples: API keys, OAuth tokens, endpoint URLs</text>

  <!-- FSIM Blocks spanning layers -->
  
  <!-- fdo.wifi - spans layer 1 only -->
  <rect x="550" y="90" width="100" height="60" rx="8" fill="#3498db" stroke="#2980b9" stroke-width="2"/>
  <text x="600" y="115" class="fsim-title" text-anchor="middle">fdo.wifi</text>
  <text x="600" y="132" class="fsim-text" text-anchor="middle">Network</text>

  <!-- fdo.payload - spans layers 1-2 -->
  <rect x="660" y="90" width="100" height="150" rx="8" fill="#e74c3c" stroke="#c0392b" stroke-width="2"/>
  <text x="710" y="145" class="fsim-title" text-anchor="middle">fdo.payload</text>
  <text x="710" y="162" class="fsim-text" text-anchor="middle">Boot images</text>
  <text x="710" y="177" class="fsim-text" text-anchor="middle">Kickstart</text>
  <text x="710" y="192" class="fsim-text" text-anchor="middle">Cloud-init</text>

  <!-- fdo.sysconfig - spans layers 2-3 -->
  <rect x="770" y="180" width="100" height="150" rx="8" fill="#e67e22" stroke="#d35400" stroke-width="2"/>
  <text x="820" y="235" class="fsim-title" text-anchor="middle">fdo.sysconfig</text>
  <text x="820" y="252" class="fsim-text" text-anchor="middle">Hostname</text>
  <text x="820" y="267" class="fsim-text" text-anchor="middle">Timezone</text>
  <text x="820" y="282" class="fsim-text" text-anchor="middle">SSH keys</text>

  <!-- fdo.credentials - spans layers 3-4 -->
  <rect x="660" y="270" width="100" height="150" rx="8" fill="#27ae60" stroke="#229954" stroke-width="2"/>
  <text x="710" y="325" class="fsim-title" text-anchor="middle">fdo.credentials</text>
  <text x="710" y="342" class="fsim-text" text-anchor="middle">Admin creds</text>
  <text x="710" y="357" class="fsim-text" text-anchor="middle">API keys</text>
  <text x="710" y="372" class="fsim-text" text-anchor="middle">OAuth tokens</text>
  <text x="710" y="387" class="fsim-text" text-anchor="middle">Certificates</text>

  <!-- Credential Storage - spans all layers -->
  <rect x="50" y="80" width="60" height="350" rx="8" fill="#34495e" stroke="#2c3e50" stroke-width="2"/>
  <text x="80" y="200" class="fsim-title" text-anchor="middle" transform="rotate(-90, 80, 255)">FDO Credentials (TPM/UEFI)</text>

  <!-- Connecting lines from credential storage to layers -->
  <line x1="110" y1="120" x2="120" y2="120" stroke="#34495e" stroke-width="2" stroke-dasharray="4,2"/>
  <line x1="110" y1="210" x2="120" y2="210" stroke="#34495e" stroke-width="2" stroke-dasharray="4,2"/>
  <line x1="110" y1="300" x2="120" y2="300" stroke="#34495e" stroke-width="2" stroke-dasharray="4,2"/>
  <line x1="110" y1="390" x2="120" y2="390" stroke="#34495e" stroke-width="2" stroke-dasharray="4,2"/>

  <!-- Legend -->
  <rect x="120" y="460" width="760" height="80" rx="5" fill="#f8f9fa" stroke="#dee2e6" stroke-width="1"/>
  <text x="140" y="485" class="layer-title">Key Insights:</text>
  <text x="140" y="505" class="note-text">• Each stage runs its own FDO TO2 exchange, potentially with different onboarding services</text>
  <text x="140" y="520" class="note-text">• FDO credentials (left bar) are reused across all stages - stored in persistent location (TPM NVRAM, UEFI vars)</text>
  <text x="500" y="505" class="note-text">• FSIMs span multiple stages (tall blocks) - same FSIM used by different components</text>
  <text x="500" y="520" class="note-text">• Different vendors implement FDO clients at each stage</text>

  <!-- Stage numbers on left -->
  <text x="30" y="125" class="stage-label">Stage 1</text>
  <text x="30" y="215" class="stage-label">Stage 2</text>
  <text x="30" y="305" class="stage-label">Stage 3</text>
  <text x="30" y="395" class="stage-label">Stage 4</text>

  <!-- Time arrow -->
  <line x1="30" y1="440" x2="30" y2="70" stroke="#999" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="25" y="450" class="stage-label" transform="rotate(-90, 25, 450)">Time / Boot sequence</text>
  
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#999" />
    </marker>
  </defs>
</svg>
